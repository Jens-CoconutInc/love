<?php
//
/**
 * Implements hook_menu().
 */
function mp_service_menu() {
  /*
   *$items['blog'] = array(
   *  'title' => 'blogs',
   *  'page callback' => 'blog_page',
   *  'access arguments' => array('access content'),
   *  'type' => MENU_SUGGESTED_ITEM,
   *);
   */
  $items['mp_service'] = array(
    'title' => 'valid&response',
    'page callback' => 'mp_service_response',
    // 'page arguments' => array(),
    'access callback' => TRUE,
    // 'type' => ,
    // 'file' => ,
  );

  return $items;
}
function mp_service_response() {
	//preg to get key_words
	module_load_include(type, module, name);
	module_load_include('inc', 'mp_service', 'mp_service');
	$wechatObj = new wechatCallbackapiTest();
	// $wechatObj->valid();
	// $wechatObj->responseMsg();

		//get post data, May be due to the different environments
		$postStr = $GLOBALS["HTTP_RAW_POST_DATA"];
    watchdog('mp-postStr', print_r($postStr,true), array(), WATCHDOG_NOTICE, 'link');
      	//extract post data
		if (!empty($postStr)){
                
    	$postObj = simplexml_load_string($postStr, 'SimpleXMLElement', LIBXML_NOCDATA);
      $fromUsername = $postObj->FromUserName;
      $toUsername = $postObj->ToUserName;
      $keyword = trim($postObj->Content);
      watchdog('mp-postObj', print_r($postObj,true), array(), WATCHDOG_NOTICE, 'link');
      $time = time();
                $textTpl = "<xml>
							<ToUserName><![CDATA[%s]]></ToUserName>
							<FromUserName><![CDATA[%s]]></FromUserName>
							<CreateTime>%s</CreateTime>
							<MsgType><![CDATA[%s]]></MsgType>
							<Content><![CDATA[%s]]></Content>
							<FuncFlag>0</FuncFlag>
							</xml>";          
				if(!empty( $keyword ))
                {
              		$msgType = "text";
                	$contentStr = t('Thanks for your focus~,we will do our best for you!');
                	$resultStr = sprintf($textTpl, $fromUsername, $toUsername, $time, $msgType, $contentStr);
                	if(!mp_get_uid_by_FromUserName($fromUsername)) {
                        //record the user in db
                  }
                  watchdog('mp_service', '<pre>'.print_r($resultStr,TRUE), array(), WATCHDOG_NOTICE, 'link');
                  echo $resultStr;

                }else{
                	echo "Input something...";
                }

        }else {
        	echo "";
        	exit;
        }
	// end response
}


function mp_get_uid_by_FromUserName($FromUserName){
	$uid = db_query('SELECT uid FROM {mp_service} WHERE fromusername = :fromusername', array(':fromusername' => $FromUserName))->fetchField();
	if($uid === FALSE) {
		$result = db_insert('mp_service')
			->fields(array(
			  'uid' => 0,
			  'fromusername' => $FromUserName,
			  'created' => REQUEST_TIME,
			))
			->execute();
		return 0;
	}
	return $uid;
}