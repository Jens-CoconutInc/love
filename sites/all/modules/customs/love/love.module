<?php

/**
 * Implements of hook_theme().
 */
function love_theme($existing, $type, $theme, $path) {
  return array(
    'love_profile_visits' => array(
      'variables' => array(
        'account'   => NULL,
        'timestamp' => NULL,
        'referer'   => NULL,
      ),
    ),
  );
}

/**
 * Theme preprocess for views-view-index.tpl.php.
 * prepare comments vars for qustion view page for both question and answers in module Level.
 * TODO:we should check in theme level 
 */
function love_preprocess_views_view(&$vars) {
  $view = $vars['view'];
  if ($view->name == 'index') {//  && $view->current_display == 'photos_page_all'
    //$vars['answer_node_form'] = druedu_node_add('answer');
    drupal_add_css(drupal_get_path('module', 'love') .'/highslide/highslide.css');
    drupal_add_js(drupal_get_path('module', 'love') .'/highslide/highslide.js');
    drupal_add_js(drupal_get_path('module', 'love') .'/highslide/highslide-cfg.js');
  }
}

/**
 * when a user invite by love group member,
 * let it join the love group too.
 * and when register ,not display let user choose which group to join,for the multilanguage bug of og.
 */
function love_user_insert(&$edit, $account, $category) {
  //2 is the love group gid.
  //$edit['og_group_ref'][LANGUAGE_NONE][0] = array('target_id'=>2);
  $account->og_group_ref[LANGUAGE_NONE][0] = array('target_id'=>2);
}

function love_node_insert($node) {
  if($node->type == 'photo') {
    $node->og_group_ref[LANGUAGE_NONE][0] = array('target_id'=>2);
  }
}

/**
 * if user visit love profile-main or profile-believes +1
 * user_visits++
 * Implements of hook_exit().
 * @see user_visits_exit()
 */
function love_exit() {
  global $user;
  $referer = $_SERVER['HTTP_REFERER'];

  // Don't count if user no has access to profile
  if (!user_access('access user profiles')) {
    return;
  }

  // Don't count anonymous-clicks.
  if (!$user->uid) {
    return;
  }

  // Don't count if role is hidden.
  if (user_visits_is_hidden($user)) {
    return;
  }

  // Try not to count clicks from the user's other profile pages.
  if (strpos($_SERVER['HTTP_REFERER'], arg(0) . '/' . arg(1))) {
    //return;//XXX why???
  }
  // Record visits on user profile pages.
  //profile-*/1
	if((strpos( arg(0),"profile-")==0) && is_numeric(arg(1)) && !arg(2)) {
		if ($user->uid != arg(1)) {
      // Count view.
      user_visits_count($user->uid, arg(1));
    }
	}
}

/**
 * Implement hook_ctools_plugin_api().
 *
 * This hook is needed to let ctools know about exportables.
 * @see heartbeat_og_ctools_plugin_api
 */
function love_ctools_plugin_api($module, $api) {
  if ($module == 'heartbeat' && $api == 'heartbeat') {
    return array('version' => 1);
  }
}
