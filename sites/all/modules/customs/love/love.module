<?php
/**
 * hook_menu_alter
 */
function love_menu_alter(&$items) {
  // Example - disable the page at node/add
  $items['publish'] = $items['node/add/photo'];
	$items['publish']['title'] = t('+Photo');
	$items['publish']['menu_name'] = 'main-menu';
	$items['publish']['weight'] = 100;

  //$items['user']['title callback'] = love_dynamic_menu_call();
}
/* TODO:XXX 
function love_dynamic_menu_call(){
  global $user;
  if($user->uid) {
    return $user->name;
  }else{
    return t('My account');
  }
}*/
/**
 * Implements of hook_theme().
 */
function love_theme($existing, $type, $theme, $path) {
  return array(
    'love_profile_visits' => array(
      'variables' => array(
        'account'   => NULL,
        'timestamp' => NULL,
        'referer'   => NULL,
      ),
    ),
  );
}

function love_init(){
  //drupal_add_js(drupal_get_path('module', 'rate') .'/rate.js');

  drupal_add_css(drupal_get_path('module', 'love') .'/highslide/highslide.css');
  drupal_add_js(drupal_get_path('module', 'love') .'/highslide/highslide.js');
  drupal_add_js(drupal_get_path('module', 'love') .'/highslide/highslide-cfg.js');

}
/**
 * Implements hook_js_alter().
 * Rate JS Order fix...

function love_js_alter(&$js) {dpm('er');
  $rateModulePath = drupal_get_path('module', 'rate');
  foreach($js as $file => $info) {
    if (strpos($file, $rateModulePath) === 0) {
      $js[$file]['scope'] = 'header';
    }
  }
} */
/**
 *  Implements hook_field_widget_form_alter($element, $form_state, $context)
 */
function china_address_field_widget_form_alter(&$form, &$form_state) {
	//TODO
}

//TODO 定制最近来访 主题9宫格
/**
 * Implements hook_block_view().
 * @see user_visits_adv_block_view($delta = '')
 */
function hook_block_view_alter($data, $block) {
  $limit = variable_get('user_visits_adv_block_items_' . $delta, 9);
  switch ($delta) {
    case 0:
      $block = array(
        'subject' => t('Latest visitors'),
        'content' => love_user_visits_adv_visitors_block($limit),
      );
      break;

  }
  return $block;
}
/**
 * Get latest visitors for block content.
 * @see user_visits_adv_visitors_block()
 */
function love_user_visits_adv_visitors_block($limit = 9) {
  global $user;
  $output = '';

  if ($user->uid) {
    $visitors = user_visits_adv_get('visitors', $user->uid);
    if (is_array($visitors)) {
      $visitors = array_slice($visitors, 0, $limit, TRUE);
      foreach ($visitors as $uid => $visit) {
        $account = db_query('SELECT uid, name, picture FROM {users} WHERE uid = :uid', array(':uid' => $uid))->fetchObject();
        $output .= theme('user_visits', array('account' => $account, 'visit' => $visit));
      }
    }
  }
  return $output;
}

function love_form_alter(&$form, &$from_state, $form_id) {
	if($form_id == 'photo_node_form'){ //node/add/photo
			//dpm($from_state);
	}

}
/**
 * if user visit love profile-main or profile-believes +1
 * user_visits++
 * Implements of hook_exit().
 * @see user_visits_exit()
 */
function love_exit() {
  global $user;
  $referer = $_SERVER['HTTP_REFERER'];

  // Don't count if user no has access to profile
  if (!user_access('access user profiles')) {
    return;
  }

  // Don't count anonymous-clicks.
  if (!$user->uid) {
    return;
  }

  // Don't count if role is hidden.
  if (user_visits_is_hidden($user)) {
    return;
  }

  // Try not to count clicks from the user's other profile pages.
  if (strpos($_SERVER['HTTP_REFERER'], arg(0) . '/' . arg(1))) {
    //return;//XXX why???
  }
  // Record visits on user profile pages.
  //profile-*/1
	if((strpos( arg(0),"profile-")==0) && is_numeric(arg(1)) && !arg(2)) {
		if ($user->uid != arg(1)) {
      // Count view.
      user_visits_count($user->uid, arg(1));
    }
	}
}
